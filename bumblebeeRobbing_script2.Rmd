---
title: "Bumblebee2"
author: "Daniel"
date: "2025-06-09"
output: pdf_document
---
Behavioral assays done on bumblebees at Rocky Mountains Biology Laboratory (RMBL) field season 2023.
Observations were carried out by Nick Dabagia and Daniel Souto for Corydalis and Mertensia species.
Y-Tube assays carried out by Oriana Gutierrez in 2024.

Methods:

Refer to Souto-Vilarós et al. 'Yeast volatiles promote larceny in bumble bee behavior.'

Data analysis:

The dataset is arranged as date, plant species, bee individual, bee species, whether or not a choice was made, stalk number, treatment, whether or not the bee tried to legitimately visit the flower, whether it robbed the flower, time to rob, time feeding, flower number (total for that bout) and additional notes. 

Note that not all packages are used in the current analysis

```{r setup, include=FALSE, results=FALSE, warning=FALSE, message=TRUE}
rm(list=ls()) #removes all objects from work space - good practice to start all R sessions with this
library('ggplot2')
library('tidyverse')
library('dplyr')
library('stats')
library('multcomp')
library('lme4')
library('lmerTest')
library('gridExtra')
#library('ggpub')
visitation<-read.csv("data/bumblebee_behavior_data.csv", header = T)
```


We need to wrangle the data a bit. Namely:
Filter the data to include only cases where a flower was robbed (column CHOICE, "Yes"),
Remove B. mixtus (we never got enough individuals),
Remove an outlier which was inactive on a flwoer over 3 minutes. Make sure all data is numeric and there are no missing data.

This final data set includes: 57 total successful robber trials (out of 116 bee trials transcribed) 42 Corydalis 2° robbers (22 bifarius, 16 flavifrons, 4 mixtus) and 15 Mertensia 2° robbers (all flavifrons)

```{r filtering data}
robbed_flowers <- visitation %>%
  filter(robbed == "yes") %>% #note that this will reduce total number of bees which made a choice since not all of them actually 'robbed'
  filter(species != "mixtus")%>%
  filter(timetorob !=154.7) 

robbed_flowers <- robbed_flowers %>%
  mutate(
    timetorob = as.numeric(timetorob),
    timefeeding = as.numeric(timefeeding)
  ) %>%
  filter(!is.na(timetorob) & !is.na(timefeeding))

robbed_flowers <- robbed_flowers %>%
  mutate(trytolegit_binary = ifelse(trytolegit == "yes", 1, 0))

#How many bees per bee species per flower species in the original and the filtered datasets?

visitation %>% group_by(sample, plantsp, species) %>% count()

robbed_flowers %>% group_by(sample, plantsp, species, bee) %>% count()
```

Simple summary statistics for time to rob (mean, SE) broken down by bumblebee species and plant sp. 
Note that time to rob is longer for control flowers, but also SE higher for controls. Consistent response for Mreu plants. Tactic switch, I just converted into a binary column yes = 1, no = 0. Feeding time is higher in both treatments, with high SE but consistent throughout.

```{r summary stats }
summary_stats <- robbed_flowers %>%
  group_by(species, treatment, plantsp) %>%
  summarize(
    Mean_TimeToRob = mean(timetorob, na.rm = TRUE),
    SE_TimeToRob = sd(timetorob, na.rm = TRUE) / sqrt(n()),
    Mean_TimeFeeding = mean(timefeeding, na.rm = TRUE),
    SE_TimeFeeding = sd(timetorob, na.rm = TRUE) / sqrt(n()),
    Mean_tacticswitch = mean(trytolegit_binary, na.rm = TRUE),
    SE_tacticswitch = sd(trytolegit_binary, na.rm = TRUE) / sqrt(n())
  ) %>% 
  arrange(plantsp, treatment)


print(summary_stats)

write.table(summary_stats, "results/summary_feeding_stats.csv", row.names = FALSE)
```


```{r}
# Summarize the data to calculate the number of visits
summary_data <- robbed_flowers %>%
  group_by(treatment, species, plantsp) %>%
  summarize(
    number_of_visits = n(),  # Count the number of visits
    .groups = "drop"
  )

# Calculate the mean, stdev, and se for each treatment group (control vs mreu)
visit_summary <- summary_data %>%
  group_by(species, plantsp) %>%
  summarize(
    mean_visits_control = mean(number_of_visits[treatment == "control"], na.rm = TRUE),
    mean_visits_treated = mean(number_of_visits[treatment == "mreu"], na.rm = TRUE),
    stdev_diff = sd(number_of_visits[treatment == "mreu"] - number_of_visits[treatment == "control"], na.rm = TRUE),
    se_diff = stdev_diff / sqrt(n()),
    .groups = "drop"
  )

# View the resulting summary table
print(visit_summary)
# Perform t-tests for each species and plantsp combination
t_test_results <- robbed_flowers %>%
  group_by(species, plantsp) %>%
  summarize(
    t_test = list(
      t.test(
        x = treatment == "mreu",    # Logical vector for mreu
        y = treatment == "control" # Logical vector for control
      )
    ),
    .groups = "drop"
  )

# Extract p-values and t-statistics from the t-test results
t_test_summary <- t_test_results %>%
  mutate(
    p_value = sapply(t_test, function(x) x$p.value),        # Extract p-value
    statistic = sapply(t_test, function(x) x$statistic)    # Extract t-statistic
  )

# Select only necessary columns
t_test_summary <- t_test_summary %>%
  dplyr::select(species, plantsp, p_value, statistic)

# View the summarized results
print(t_test_summary)

# Extract p-values, t-statistics, and degrees of freedom from the t-test results
t_test_summary <- t_test_results %>%
  mutate(
    p_value = sapply(t_test, function(x) x$p.value),        # Extract p-value
    statistic = sapply(t_test, function(x) x$statistic),    # Extract t-statistic
    df = sapply(t_test, function(x) x$parameter)            # Extract degrees of freedom
  )

# Explicitly use dplyr::select()
t_test_summary <- t_test_summary %>%
  dplyr::select(species, plantsp, p_value, statistic, df)

# View the summarized results
print(t_test_summary)
```

```{r}

# Create a histogram
ggplot(robbed_flowers, aes(x = interaction(species, plantsp), fill = treatment)) +
  geom_bar(position = "dodge", color = "black") +
  labs(x = NULL,
    y = "Number of Visits",
    fill = "Flower Treatment"
  ) +
  scale_fill_manual(
    values = c("mreu" = "#4169E1",
               "control" = "#FAFAD2")
  )+
  theme_minimal() +
  theme(
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9)
  ) -> plot

plot

ggsave("results/bee_visits_histogram.pdf", plot = plot, width = 8, height = 6)
```
```{r}

summary_df <- robbed_flowers %>%
  group_by(group = interaction(species, plantsp), treatment) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(group) %>%
  summarise(
    max_y = max(count),
    x_pos = as.numeric(factor(group)),  # for proper placement on x axis
    .groups = "drop"
  ) %>%
  mutate(label = "*")

ggplot(robbed_flowers, aes(x = interaction(species, plantsp), fill = treatment)) +
  geom_bar(position = position_dodge(width = 0.9), color = "black") +
  geom_text(
    data = summary_df,
    aes(x = group, y = max_y + 2, label = label),
    inherit.aes = FALSE,
    size = 6
  ) +
  labs(x = NULL,
       y = "Number of Visits",
       fill = "Flower Treatment") +
  scale_fill_manual(
    values = c("mreu" = "#4169E1", "control" = "#FAFAD2")
  ) +
  theme_minimal() +
  theme(
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9)
  ) -> plot2

plot2

```